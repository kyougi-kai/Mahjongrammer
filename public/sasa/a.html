<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="gameplay.css">
</head>
<body>
    <button onclick="nanka.showHai();">start</button>
    <div class="footer">
        <div class="hai-table" id="wordUp"></div>
        <div class="hai-table" id="wordDown"></div>
    </div>
    <script src="../js/until/dmcopy.js"></script>
    <script defer>
        class HaiMG{
            constructor(){
                this._dm = new DM();
                this._idCounter = 0;
                this._draggedElement = null;
                this._originalParent = null;
                this._movedAnotherParent = false;

                document.querySelectorAll('.hai-table').forEach((parent, index) => {
                    parent.addEventListener('dragover', event => {
                        event.preventDefault(); // Allow drop
                        if (!this._draggedElement) return;
                        const tables = [...document.querySelectorAll('.hai-table')];

                        const childrenCount = Array.from(tables[index].children).length;
                        if(childrenCount == 0 || event.clientX > tables[index].children[childrenCount - 1]?.getBoundingClientRect().right){
                            tables[index].appendChild(this._draggedElement);
                        }

                        tables.forEach(table => {
                            Array.from(table.children).forEach((hai) => {
                                if (hai !== this._draggedElement) {
                                    let rect = hai.getBoundingClientRect();
                                    let centerX = rect.left + rect.width / 2;

                                    if (event.clientX > rect.left && event.clientX < rect.right && event.clientY > rect.top && event.clientY < rect.bottom) {
                                        const idx = Array.from(table.children).indexOf(hai);
                                        if(!this._movedAnotherParent && this._originalParent != hai.parentNode){
                                            hai.parentNode.insertBefore(this._draggedElement, hai);
                                        }
                                        else if(idx > Array.from(table.children).indexOf(this._draggedElement)){
                                            hai.parentNode.insertBefore(this._draggedElement, hai.nextSibling);
                                        }
                                        else{
                                            hai.parentNode.insertBefore(this._draggedElement, hai);
                                        }

                                        if(this._originalParent != hai.parentNode)this._movedAnotherParent = true;
                                    }
                                }
                            })
                        });
                    });

                    parent.addEventListener('drop', event => {
                        event.preventDefault();
                        if(this._draggedElement){
                            this._draggedElement.style.opacity = '1'
                            this._draggedElement = null;
                        }
                    });
                });

                // Allow dropping anywhere in the document
                document.addEventListener('dragover', event => {
                    event.preventDefault(); // Allow drop on the document body
                });

                document.addEventListener('drop', event => {
                    event.preventDefault();
                    if (this._draggedElement) {
                        const target = document.querySelector('.footer');
                        target.appendChild(this._draggedElement); // Append the dragged element to footer or any other location
                        this._draggedElement.style.opacity = '1';
                        this._draggedElement = null;
                    }
                });
            }

            showHai(){
                const borderDiv = document.createElement('div');
                borderDiv.classList.add('border-div');
                borderDiv.textContent = this._dm.pickTango();
                borderDiv.setAttribute('draggable', 'true');
                borderDiv.id = `hai-${this._idCounter++}`;

                borderDiv.addEventListener('dragstart', event => {
                    this._movedAnotherParent = false;
                    event.dataTransfer.setData('text/plain', event.target.id);
                    this._draggedElement = event.target;
                    this._originalParent = this._draggedElement.parentNode;
                    setTimeout(() => event.target.style.opacity = '0.25', 0);
                    console.log(this._draggedElement);
                });

                borderDiv.addEventListener('dragend', event => {
                    if(!this._draggedElement)return;
                    this._draggedElement.style.opacity = '1';
                    this._draggedElement = null;
                });

                document.getElementById('wordDown').appendChild(borderDiv);

                return borderDiv;
            }
        }

        let nanka = new HaiMG();
    </script>
</body>
</html>
